apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
  - gatus-version-ingress.yaml
  - ../../../../databases/bitnami-postgresql-15.3.0-debian-11-r7/overlays/staging

patches:
  - target:
      name: postgres-wsp-postgresql
      kind: Secret
    path: secret.patch.yaml
  - target:
      name: gatus
      kind: Ingress
    path: ingress.patch.yaml
  - target:
      name: gatus
      kind: ConfigMap
    path: configmap.patch.yaml

images:
  - name: DOCKER_IMAGE_1
    newName: gitlab.krz.de:4567/customers/publicplan/wsp/staging/images/gatus
    newTag: stage-0eaa68de
  - name: DOCKER_IMAGE_1_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/common/app-configs/gatus
    newTag: stage-0eaa68de
  - name: DOCKER_IMAGE_2
    newName: gitlab.krz.de:4567/customers/publicplan/wsp/staging/images/version-sidecar
    newTag: v1.3.1
  - name: DOCKER_IMAGE_2_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/version-sidecar
    newTag: v1.3.1
  - name: DOCKER_IMAGE_3
    newName: gitlab.krz.de:4567/customers/publicplan/wsp/staging/images/busybox
    newTag: "1.36"
  - name: DOCKER_IMAGE_3_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/common/app-configs/busybox
    newTag: "1.36"

replacements: #version sidecar replacements
- source:
    kind: Deployment
    name: gatus
    fieldPath: spec.template.spec.containers.[name=gatus].image
  targets:
  - select:
      kind: Deployment
      name: gatus
    fieldPaths:
      - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_1].value
    options:
      create: true
- source:
    kind: Deployment
    name: gatus
    fieldPath: spec.template.spec.containers.[name=version-sidecar].image
  targets:
  - select:
      kind: Deployment
      name: gatus
    fieldPaths:
      - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_2].value
    options:
      create: true
