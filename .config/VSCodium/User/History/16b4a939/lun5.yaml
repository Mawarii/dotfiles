---
- name: Ensure caddy directory exists
  ansible.builtin.file:
    path: "{{ caddy_install_path }}"
    state: directory

- name: Generate Caddyfile
  ansible.builtin.template:
    src: "Caddyfile.j2"
    dest: "{{ caddy_install_path }}/Caddyfile"

- name: Generate caddy compose file
  ansible.builtin.template:
    src: "caddy-compose.yaml.j2"
    dest: "{{ caddy_install_path }}/compose.yaml"

- name: Create reverse_proxy Docker network if caddy_proxy is disabled
  community.docker.docker_network:
    name: reverse_proxy

- name: Create caddy_data Docker volume
  community.docker.docker_volume:
    name: caddy_data

- name: Create and start services
  community.docker.docker_compose_v2:
    project_src: "{{ caddy_install_path }}"
