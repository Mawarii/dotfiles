apiVersion: batch/v1
kind: CronJob
metadata:
  name: govforms2-rabbitmq-consumer-job
  labels:
    k8s-env: pre-stage
spec:
  schedule: "* * * * *"
  suspend: false # temporary disable cronjob
  jobTemplate:
    spec:
      template:
        spec:
          imagePullSecrets:
            - name: gitlab-registry-govforms2-workflow-core
          containers:
            - name: rabbitmq-consumer-job
              command:
                - /bin/sh
                - -c
                - "/usr/local/bin/php /srv/app/bin/console messenger:setup-transports && /usr/local/bin/php /srv/app/bin/console messenger:consume async --time-limit=60 -vvv"
              env:
                - name: APP_ENV
                  value: "prestage"
                - name: DATABASE_PW
                  valueFrom:
                    secretKeyRef:
                      name: mariadb-wsp-secret
                      key: mariadb-password
                - name: DATABASE_USER
                  valueFrom:
                    secretKeyRef:
                      name: mariadb-wsp-secret
                      key: mariadb-user
                - name: DATABASE_URL_ANTRAG
                  value: "mysql://mariadb:$(DATABASE_PW)@mariadb.govforms2-workflow-core.svc:3306/antrag?serverVersion=mariadb-10.11.2&charset=utf8"
                - name: DATABASE_URL_USER
                  value: "mysql://mariadb:$(DATABASE_PW)@mariadb.govforms2-workflow-core.svc:3306/user?serverVersion=mariadb-10.11.2&charset=utf8"
                - name: DATABASE_URL_TENANT
                  value: "mysql://mariadb:$(DATABASE_PW)@mariadb.govforms2-workflow-core.svc:3306/tenant?serverVersion=mariadb-10.11.2&charset=utf8"
                - name: DATABASE_URL_FORM
                  value: "mysql://mariadb:$(DATABASE_PW)@mariadb.govforms2-workflow-core.svc:3306/form?serverVersion=mariadb-10.11.2&charset=utf8"
                - name: REDIS_URL
                  value: "redis://redis-sentinel-sentinel.govforms2-workflow-core.svc:26379"
                - name: REDIS_TTL
                  value: "1800"
                - name: MINIO_ROOT_USER
                  valueFrom:
                    secretKeyRef:
                      name: minio-secrets
                      key: root-user
                - name: MINIO_ROOT_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: minio-secrets
                      key: root-password
                - name: MINIO_ENDPOINT
                  value: "http://minio-service.govforms2-workflow-core.svc:9000"
                - name: CLAMAV_HOST
                  value: "tcp://clamav-service.clamav.svc:3310"
                - name: CLIENT_URL
                  value: "efa.govforms2-client.pre-stage.wspdev.de"
                - name: GF2_MESSENGER_FORCE_EMAIL
                  value: "false"
                - name: SENDER_ADDRESS
                  value: "efa@publicplan.de"
                - name: MAILBOX_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: govforms2-workflow-core-secrets
                      key: MAILBOX_PASSWORD
                - name: MAILER_DSN
                  value: "smtp://efa%40publicplan.de:$(MAILBOX_PASSWORD)@smtp.office365.com:587?verify_peer=1"
                - name: RABBITMQ_DEFAULT_USER
                  value: "govforms2"
                - name: RABBITMQ_DEFAULT_PASS
                  valueFrom:
                    secretKeyRef:
                      name: rabbitmq-auth
                      key: rabbitmq-password
                - name: RABBITMQ_URL
                  value: "rabbitmq-headless.govforms2-workflow-core.svc:5672"
                - name: RABBITMQ_DSN
                  value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@$(RABBITMQ_URL)"
