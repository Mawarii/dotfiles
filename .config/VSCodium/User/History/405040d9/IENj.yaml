---
- name: Check which SSH port is available
  ansible.builtin.wait_for:
    port: "{{ ssh_port }}"
    host: "{{ inventory_hostname }}"
    timeout: 3
  register: ssh_port_22
  ignore_errors: true
  delegate_to: localhost
  become: false

- name: "Set SSH port and user to the detected values"
  ansible.builtin.set_fact:
    ansible_port: "{{ default_ssh_port if ssh_port_22.failed == false else ssh_port }}"
    ansible_user: "{{ default_ssh_user if ssh_port_22.failed == false else ssh_user }}"
