---
- name: Check which SSH port is available
  ansible.builtin.wait_for:
    port: "{{ ssh_port }}"
    host: "{{ inventory_hostname }}"
    timeout: 3
  register: custom_ssh_port
  ignore_errors: true
  delegate_to: localhost
  become: false

- name: "Set SSH port and user to the detected values"
  ansible.builtin.set_fact:
    ansible_port: "{{ default_ssh_port if custom_ssh_port.failed == true else ssh_port }}"
    ansible_user: "{{ default_ssh_user if custom_ssh_port.failed == true else ssh_user }}"
