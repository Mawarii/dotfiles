apiVersion: apps/v1
kind: Deployment
metadata:
    name: drupal
spec:
    replicas: 0
    strategy:
        type: Recreate
    selector:
        matchLabels:
            app: drupal
            layer: public
    template:
        metadata:
            name: drupal
            labels:
                app: drupal
                layer: public
        spec:
            imagePullSecrets:
                -   name: pullsecret-newsletter
            containers:
                -   name: drupal
                    image: gitlab.publicplan.cloud:5050/themenwelt-portale/recht-nrw-newsletter
#                    lifecycle:
#                        postStart:
#                            exec:
#                                command:
#                                    - /bin/bash
#                                    - -c
#                                    - export drush=vendor/drush/drush/drush && $drush cr -v && $drush updb -y && $drush cim -y && $drush cr && $drush locale-check && $drush locale-update && $drush cr
                    imagePullPolicy: Always
                    ports:
                        -   containerPort: 8080
                            protocol: TCP
                    resources:
                        requests:
                            cpu: 500m
                            memory: 512M
                        limits:
                            cpu: 500m
                            memory: 512M
                    securityContext:
                        runAsUser: 33
                        runAsGroup: 33
                        allowPrivilegeEscalation: false
                        readOnlyRootFilesystem: true
                        runAsNonRoot: true
                        capabilities:
                            drop: [ "ALL" ]
                        seccompProfile:
                            type: RuntimeDefault
                    volumeMounts:
                        -   mountPath: /var/www/html/web/sites/default/files
                            name: files
                        -   mountPath: /var/www/html/private
                            name: private
                        -   mountPath: /var/run
                            name: varrun
                        -   mountPath: /tmp
                            name: tmp
            initContainers:
                -   command:
                        - sh
                        - -c
                        - |
                            mkdir -p "/srv/files" "/srv/private"
                            chown -R "33:33" "/srv/files" "/srv/private"
                    image: docker.io/bitnami/os-shell:11-debian-11-r90
                    imagePullPolicy: IfNotPresent
                    name: volume-permissions
                    resources: { }
                    securityContext:
                        runAsUser: 0
                    volumeMounts:
                        -   mountPath: /srv/files
                            name: files
                        -   mountPath: /srv/private
                            name: private
            restartPolicy: Always
            volumes:
                -   name: files
                    persistentVolumeClaim:
                        claimName: files
                -   name: private
                    persistentVolumeClaim:
                        claimName: private
                -   name: varrun
                    emptyDir: { }
                -   name: tmp
                    emptyDir: { }