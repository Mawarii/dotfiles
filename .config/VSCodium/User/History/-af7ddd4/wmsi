# Containerfile
FROM harbor.dev.publicplan.cloud/docker_proxy/debian:sid AS base

# hadolint ignore=DL3008
RUN apt-get update && \
    apt-get install -y \
        postgresql-client \
        default-mysql-client \
        curl \
        gnupg \
        mariadb-client \
        ca-certificates \
        --no-install-recommends && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# hadolint ignore=DL4006
RUN curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \
        gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg \
        --dearmor

# hadolint ignore=DL4006
RUN echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/7.0 main" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# hadolint ignore=DL3008
RUN apt-get update && \
    apt-get install --no-install-recommends -y mongodb-org && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN curl https://dl.min.io/client/mc/release/linux-amd64/mc --create-dirs -o /usr/bin/mc && \
    chmod +x /usr/bin/mc && \
    ln -s /usr/bin/mc /usr/bin/mcli 

FROM base AS toolchain

RUN adduser --uid 10001 --shell /bin/bash tools
WORKDIR /home/tools

COPY ["./backup-job.sh", "/usr/local/bin"]

ENV SOURCE_LOCATION="/usr/share/backup-job"
COPY ["./sources", "${SOURCE_LOCATION}"]

# Copy to 'global' location since /home/tools will be mounted later
RUN chmod +x "/usr/local/bin/backup-job.sh"

USER tools

# This needs to be writable
VOLUME [ "/tmp" ]

ENTRYPOINT [ "sh", "-c", "/usr/local/bin/backup-job.sh" ]
