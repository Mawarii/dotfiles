---
- name: Generate Cert-Manager default values file
  ansible.builtin.copy:
    src: "{{ role_path }}/templates/default-values.yaml"
    dest: /tmp/cert-manager-default-values.yaml
    mode: '0640'

- name: Generate Cert-Manager values file
  ansible.builtin.template:
    src: "{{ role_path }}/templates/values.yaml.j2"
    dest: /tmp/cert-manager-values.yaml
    mode: '0640'

- name: Add Jetstack chart repo
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: "https://charts.jetstack.io"

- name: Install Cert-Manager via Helm
  kubernetes.core.helm:
    atomic: true
    kubeconfig: /etc/kubernetes/admin.conf
    chart_ref: jetstack/cert-manager
    chart_version: "{{ cert_manager.chart_version }}"
    release_state: present
    release_name: cert-manager
    release_namespace: "{{ cert_manager.namespace }}"
    values_files:
      - /tmp/cert-manager-default-values.yaml
      - /tmp/cert-manager-values.yaml
    wait: true

- name: Generate Let's Encrypt issuer manifest
  ansible.builtin.template:
    src: "{{ role_path }}/templates/letsencrypt-issuer.yaml.j2"
    dest: /tmp/letsencrypt-issuer.yaml
    mode: '0640'

- name: Apply Let's Encrypt issuer manifest
  kubernetes.core.k8s:
    state: present
    src: /tmp/letsencrypt-issuer.yaml
