---
- name: Add firewall rule for default SSH port
  when: hcloud_token != ""
  hetzner.hcloud.firewall:
    api_token: "{{ hcloud_token }}"
    name: "default_ssh_port"
    rules:
      - port: 22
        protocol: tcp
        direction: in
        source_ips:
          - 0.0.0.0/0
    state: present
  delegate_to: 127.0.0.1

- name: Apply default SSH port firewall to all cluster machines
  when: hcloud_token != ""
  hetzner.hcloud.firewall_resource:
    api_token: "{{ hcloud_token }}"
    firewall: "default_ssh_port"
    label_selectors:
      - vm-type=controlplane
      - vm-type=worker
    state: present
  delegate_to: 127.0.0.1
