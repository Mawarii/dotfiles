apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

commonLabels:
  env: pre-stage

resources:
  - ../../../base
  - ../../../bitnami-phpmyadmin-5.2.1-debian-12-r20/overlays/pre-stage
  - ./empfangsclient-pma-ingress.yaml
  - ./empfangsclient-ecc-secrets.yaml
  - ./empfangsclient-ecc-configmap.yaml
  - ./empfangsclient-ecc-version-ingress.yaml
  - ./empfangsclient-ecc-service-account.yaml
  - ./empfangsclient-ecc-role.yaml
  - ./empfangsclient-ecc-role-binding.yaml
  - ./empfangsclient-ecc-servicemonitor.yaml
  - ./empfangsclient-ecc-hpa.yaml

images:
  - name: DOCKER_IMAGE_1
    newName: gitlab.publicplan.cloud:5050/themenwelt-portalverbund/empfangs-client/ecc
    newTag: v2.4.0
  - name: DOCKER_IMAGE_1_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-portalverbund/empfangs-client/ecc
    newTag: v2.4.0
  - name: DOCKER_IMAGE_2
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/version-sidecar
    newTag: v1.3.2
  - name: DOCKER_IMAGE_2_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/version-sidecar
    newTag: v1.3.2

patches:
  - path: empfangsclient-ecc.patch.yaml
    target:
      kind: Deployment
      name: empfangsclient-ecc

replacements: #version sidecar replacements
  - source:
      fieldPath: spec.template.spec.containers.[name=empfangsclient-ecc].image
      kind: Deployment
      name: empfangsclient-ecc
    targets:
      - fieldPaths:
          - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_1].value
        options:
          create: true
        select:
          kind: Deployment
          name: empfangsclient-ecc
  - source:
      fieldPath: spec.template.spec.containers.[name=version-sidecar].image
      kind: Deployment
      name: empfangsclient-ecc
    targets:
      - fieldPaths:
          - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_2].value
        options:
          create: true
        select:
          kind: Deployment
          name: empfangsclient-ecc

secretGenerator:
  - name: mariadb-auth
    envs:
    - ./mixins/mariadb-auth.secret.env
    options:
      disableNameSuffixHash: true
  - name: gitlab-registry-ecc
    type: kubernetes.io/dockerconfigjson
    files:
    - .dockerconfigjson=./mixins/ecc-image-pull-secret.json
    options:
      disableNameSuffixHash: true
  - name: gitlab-registry-version-sidecar
    type: kubernetes.io/dockerconfigjson
    files:
    - .dockerconfigjson=./mixins/version-sidecar-image-pull-secret.json
    options:
      disableNameSuffixHash: true