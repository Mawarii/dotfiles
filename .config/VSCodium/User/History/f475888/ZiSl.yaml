---
- name: Add Kubernetes apt repository
  block:
    - name: Remove old Kubernetes signing key
      ansible.builtin.file:
        path: "/usr/share/keyrings/kubernetes-key.gpg"
        state: absent

    - name: Remove old Kubernetes sources
      ansible.builtin.file:
        path: "/etc/apt/sources.list.d/kubernetes-stable.list"
        state: absent

    - name: Download Kubernetes signing key
      ansible.builtin.apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key
        keyring: /usr/share/keyrings/kubernetes-key.gpg
        state: present

    - name: Add Kubernetes sources
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/kubernetes-key.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /"
        state: present
        filename: "kubernetes-stable"

- name: Add CRI-O apt repository
  when: "crio_version is version('1.28', '>=', strict=true)"
  block:
    - name: Remove old CRI-O sources
      ansible.builtin.file:
        path: "/etc/apt/sources.list.d/cri-o-stable.list"
        state: absent

    - name: Download CRI-O signing key
      ansible.builtin.apt_key:
        url: https://pkgs.k8s.io/addons:/cri-o:/stable:/v{{ crio_version }}/deb/Release.key
        keyring: /usr/share/keyrings/crio-keyring.gpg
        state: present

    - name: Add CRI-O sources
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/crio-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/stable:/v{{ crio_version }}/deb/ /"
        state: present
        filename: "cri-o-stable"

- name: Update all packages to their latest version
  ansible.builtin.apt:
    name: "*"
    state: latest
    update_cache: true

- name: Upgrade and install
  ansible.builtin.apt:
    pkg:
      - jq
      - cri-o
      - kubelet
      - kubeadm
      - kubectl
    state: latest
    allow_change_held_packages: true
    update_cache: true

- name: Hold packages
  block:
    - name: Holding kubeadm package
      ansible.builtin.dpkg_selections:
        name: kubeadm
        selection: hold

    - name: Holding kubelet package
      ansible.builtin.dpkg_selections:
        name: kubelet
        selection: hold

    - name: Holding kubectl package
      ansible.builtin.dpkg_selections:
        name: kubectl
        selection: hold

    - name: Holding cri-o package
      ansible.builtin.dpkg_selections:
        name: cri-o
        selection: hold

- name: Remove dependencies that are no longer required
  ansible.builtin.apt:
    autoremove: true
