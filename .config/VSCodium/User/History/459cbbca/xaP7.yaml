---
- name: Ensure {{ installation_path }}/{{ folder.keycloak }} directory exists
  ansible.builtin.file:
    path: "{{ installation_path }}/{{ folder.keycloak }}/imports"
    state: directory

- name: Generate formsflow realm import file
  ansible.builtin.template:
    src: "./keycloak/formsflow-ai-realm.json.j2"
    dest: "{{ installation_path }}/{{ folder.keycloak }}/imports/formsflow-ai-realm.json"

- name: Check whether .env already exists so that the passwords are not overwritten
  ansible.builtin.stat:
    path: "{{ installation_path }}/{{ folder.keycloak }}/.env"
  register: stat_res

- name: Generate keycloak .env file if it does not exist
  ansible.builtin.template:
    src: "./keycloak/keycloak.env.j2"
    dest: "{{ installation_path }}/{{ folder.keycloak }}/.env"
  when: not stat_res.stat.exists

- name: Generate keycloak compose file
  ansible.builtin.template:
    src: "./keycloak/keycloak-compose.yaml.j2"
    dest: "{{ installation_path }}/{{ folder.keycloak }}/compose.yaml"

- name: Create and start services
  community.docker.docker_compose_v2:
    project_src: "{{ installation_path }}/{{ folder.keycloak }}"
    wait: true

# - name: Wait for Keycloak service to be ready
#   ansible.builtin.pause:
#     seconds: 40
