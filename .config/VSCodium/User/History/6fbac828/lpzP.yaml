apiVersion: apps/v1
kind: Deployment
metadata:
  name: oots-projectathon
spec:
  revisionHistoryLimit: 1
  strategy:
    type: Recreate
  replicas: 1
  selector:
    matchLabels:
      k8s-app: oots-projectathon
  template:
    metadata:
      labels:
        k8s-app: oots-projectathon
    spec:
      containers:
        - name: application
          image: gitlab.publicplan.cloud:5050/regmo/oots-projectathon:latest
          command:
            - "/bin/sh"
            - "-c"
            - |
              mkdir -p /var/lib/nginx/logs /var/www/project/var/log /var/log && \
              chown www-data:www-data -R /var/www/project/var/log && chown www-data:www-data -R /var/log && chown www-data:www-data -R /var/lib/nginx/logs && /
              setfacl -R -m u:www-data:rwx /var/www/project/var/log && setfacl -R -m u:www-data:rwx /var/log && setfacl -R -m u:www-data:rwx /var/lib/nginx/logs && / 
              /var/www/project/bin/console doctrine:migrations:migrate -n && \
              crond && php-fpm -D && nginx -g 'daemon off;'
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: database-dsn
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: db-host
            - name: DB_VERSION
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: db-version
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: db-name
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: db-user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: "mariadb"
                  key: db-password
            - name: APP_ENV
              value: "prod"
            - name: PREVIEW_URL_TEMPLATE
              value: "https://oots-preview-space.dev.efa.publicplan.cloud/evidence-provider/preview-space?conversation-id={conversationId}"
            - name: DOMIBUS_PARTY_ID
              value: "AP_DE_01"
            - name: DOMIBUS_PARTY_TYPE
              value: "urn:oasis:names:tc:ebcore:partyid-type:unregistered:DE"
            - name: DOMIBUS_ENDPOINT
              value: "https://domibus.pre-stage.wspdev.de/domibus/services/wsplugin"
            - name: SENTRY_DSN
              value: "https://7617ae3e706143e29af6307dd1d0cb16@sentry.dev.publicplan.cloud/12"
          securityContext:
          #   runAsUser: 10001
          #   runAsGroup: 10001
            allowPrivilegeEscalation: true
          #   readOnlyRootFilesystem: true
          #   runAsNonRoot: true
          #   capabilities:
          #     drop: [ "NET_RAW" ]
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 5
            timeoutSeconds: 1
            periodSeconds: 15
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 15
            timeoutSeconds: 1
            periodSeconds: 15
          ports:
            - containerPort: 80
          volumeMounts:
            - name: oots-projectathon-log
              mountPath: /var/www/project/var/log
            - name: log
              mountPath: /var/log
            - name: nginx-logs
              mountPath: /var/lib/nginx/logs
            # - name: project-cache
            #   mountPath: /var/www/project/var/cache
            # - name: tmp
            #   mountPath: /tmp
      imagePullSecrets:
        - name: gitlab-registry
      volumes:
        - name: oots-projectathon-log
          persistentVolumeClaim:
            claimName: oots-projectathon-log-pvc
        - name: log
          persistentVolumeClaim:
            claimName: log-pvc
        - name: nginx-logs
          persistentVolumeClaim:
            claimName: nginx-log-pvc
        # - name: project-cache
        #   emptyDir: { }
        # - name: tmp
        #   emptyDir: { }
