---
- name: Get local IP address
  ansible.builtin.set_fact:
    local_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(local_ip_address_range) }}"

- name: Generate join template
  ansible.builtin.template:
    src: ./templates/join-{{ group_names[0] }}.yaml.j2
    dest: /tmp/join-{{ group_names[0] }}.yaml
    mode: '0700'

- name: Check if node is already joined
  ansible.builtin.shell: |
    sudo kubeadm join phase preflight --config /tmp/{{ group_names[0] }}.yaml
  changed_when: false
  ignore_errors: true
  register: preflight

- name: DEBUG
  ansible.builtin.debug:
    msg: "{{ preflight }}"

- name: Run join command
  ansible.builtin.shell: |
    sudo kubeadm join --config /tmp/join-{{ group_names[0] }}.yaml
  changed_when: false
  when: not preflight.failed
