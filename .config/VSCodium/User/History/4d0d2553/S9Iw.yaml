---
- name: Upgrade kubeadm package
  ansible.builtin.apt:
    pkg:
      - kubeadm={{ kube_version_latest }}
    state: present
    update_cache: true
    allow_change_held_packages: true

- name: Hold kubeadm package
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: hold

- name: Apply kubeadm upgrade
  ansible.builtin.command:
    cmd: kubeadm upgrade node
  changed_when: true

- name: Drain node
  ansible.builtin.command: |
    kubectl drain {{ inventory_hostname }} \
      --ignore-daemonsets \
      --delete-emptydir-data \
      --grace-period=120 \
      --timeout=300s \
      --kubeconfig /etc/kubernetes/admin.conf
  changed_when: true
  delegate_to: "{{ groups['controlplanes'][0] }}"

- name: Wait for the drain to finish
  ansible.builtin.pause:
    seconds: 30

- name: Upgrade other Kubernetes packages
  ansible.builtin.apt:
    pkg:
      - kubelet={{ kube_version_latest }}
      - kubectl={{ kube_version_latest }}
    state: present
    update_cache: true
    allow_change_held_packages: true

- name: Hold kubelet package
  ansible.builtin.dpkg_selections:
    name: kubelet
    selection: hold

- name: Hold kubectl package
  ansible.builtin.dpkg_selections:
    name: kubectl
    selection: hold
