apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../base
  - domibus-version-ingress.yaml

patches:
  - path: domibus.patch.yaml
    target:
      kind: Deployment
      name: domibus
  - path: domibus-ingress.patch.yaml
    target:
      kind: Ingress
      name: domibus-ingress

images:
  - name: DOCKER_IMAGE_1
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/images/regmo/domibus-tomcat
    newTag: v1.2.4
  - name: DOCKER_IMAGE_1_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/images/regmo/domibus-tomcat
    newTag: v1.2.4
  - name: DATABASE_DOCKER_IMAGE_1
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/images/regmo/domibus-mysql
    newTag: v1.2.0
  - name: DATABASE_DOCKER_IMAGE_1_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/images/regmo/domibus-mysql
    newTag: v1.2.0
  - name: DOCKER_IMAGE_2
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/version-sidecar
    newTag: v1.3.1
  - name: DOCKER_IMAGE_2_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/version-sidecar
    newTag: v1.3.1
  - name: DATABASE_DOCKER_IMAGE_2
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/backup-jobs
    newTag: "v1.2.3"
  - name: DATABASE_DOCKER_IMAGE_2_ORIGIN
    newName: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/backup-jobs
    newTag: "v1.2.3"
  - name: DATABASE_DOCKER_IMAGE_99
    newName: "gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/database-http-healthcheck/healthcheck"
    newTag: "v1.1.0"
  - name: DATABASE_DOCKER_IMAGE_99_ORIGIN
    newName: "gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/database-http-healthcheck/healthcheck"
    newTag: "v1.1.0"

replacements: #version sidecar replacements
  - source:
      kind: Deployment
      name: domibus
      fieldPath: spec.template.spec.containers.[name=domibus].image
    targets:
    - select:
        kind: Deployment
        name: domibus
      fieldPaths:
        - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_1].value
      options:
        create: true
  - source:
      kind: Deployment
      name: domibus
      fieldPath: spec.template.spec.containers.[name=version-sidecar].image
    targets:
    - select:
        kind: Deployment
        name: domibus
      fieldPaths:
        - spec.template.spec.containers.[name=version-sidecar].env.[name=DOCKER_IMAGE_2].value
      options:
        create: true
  - source:
      kind: Deployment
      name: domibus-mysql
      fieldPath: spec.template.spec.containers.[name=mysql].image
    targets:
    - select:
        kind: Deployment
        name: domibus
      fieldPaths:
        - spec.template.spec.containers.[name=version-sidecar].env.[name=DATABASE_DOCKER_IMAGE_1].value
      options:
        create: true
