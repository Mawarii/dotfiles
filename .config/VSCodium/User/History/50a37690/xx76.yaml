apiVersion: apps/v1
kind: Deployment
metadata:
  name: govforms2-workflow-core
  labels:
    k8s-env: develop
spec:
  template:
    spec:
      initContainers:
        - name: minio-create-bucket
          env:
            - name: MINIO_HOSTNAME
              value: "minio-service.govforms2-workflow-core-test.svc"
        - name: database-migrate
          env:
            - name: DATABASE_PW
              valueFrom:
                secretKeyRef:
                  name: mariadb-wsp-secret
                  key: mariadb-password
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: mariadb-wsp-secret
                  key: mariadb-user
            - name: DATABASE_URL_ANTRAG
              value: "mysql://$(DATABASE_USER):$(DATABASE_PW)@mariadb.govforms2-workflow-core-test.svc:3306/antrag?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_USER
              value: "mysql://$(DATABASE_USER):$(DATABASE_PW)@mariadb.govforms2-workflow-core-test.svc:3306/user?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_TENANT
              value: "mysql://$(DATABASE_USER):$(DATABASE_PW)@mariadb.govforms2-workflow-core-test.svc:3306/tenant?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_FORM
              value: "mysql://$(DATABASE_USER):$(DATABASE_PW)@mariadb.govforms2-workflow-core-test.svc:3306/form?serverVersion=mariadb-10.11.2&charset=utf8"
      containers:
        - name: application
          env:
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-user
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-password
            - name: MINIO_ENDPOINT
              value: "http://minio-service.govforms2-workflow-core-test.svc:9000"
            - name: DATABASE_PW
              valueFrom:
                secretKeyRef:
                  name: mariadb-wsp-secret
                  key: mariadb-password
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: mariadb-wsp-secret
                  key: mariadb-user
            - name: DATABASE_URL_ANTRAG
              value: "mysql://mariadb:$(DATABASE_PW)@mariadb:3306/antrag?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_USER
              value: "mysql://mariadb:$(DATABASE_PW)@mariadb:3306/user?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_TENANT
              value: "mysql://mariadb:$(DATABASE_PW)@mariadb:3306/tenant?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: DATABASE_URL_FORM
              value: "mysql://mariadb:$(DATABASE_PW)@mariadb:3306/form?serverVersion=mariadb-10.11.2&charset=utf8"
            - name: REDIS_PW
              valueFrom:
                secretKeyRef:
                  key: redis-password
                  name: redis-standalone
            - name: REDIS_URL
              value: "redis://default:$(REDIS_PW)@redis-master:6379"
            - name: MAILBOX_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: govforms2-workflow-core-secrets
                  key: MAILBOX_PASSWORD
            - name: MAILER_DSN
              value: "smtp://efa%40publicplan.de:$(MAILBOX_PASSWORD)@smtp.office365.com:587?verify_peer=1"
            - name: RABBITMQ_DEFAULT_USER
              value: "govforms2"
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: rabbitmq
                  key: rabbitmq-password
            - name: RABBITMQ_URL
              value: "rabbitmq-headless.govforms2-workflow-core-test.svc:5672"
            - name: RABBITMQ_DSN
              value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@$(RABBITMQ_URL)"
          envFrom:
            - secretRef:
                name: govforms2-workflow-core-secrets
            - configMapRef:
                name: govforms2-workflow-core-configmap

