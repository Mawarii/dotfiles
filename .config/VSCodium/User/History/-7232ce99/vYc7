# Base image
FROM php:8.1.16-fpm-alpine3.17 AS base

ARG APPDIR=/var/www/project
WORKDIR ${APPDIR}
COPY build/app/default.conf /etc/nginx/http.d/default.conf
RUN apk add --no-cache unzip openssh git busybox-suid go

# Build stage for development environment
FROM base AS develop

# Install composer
COPY --from=composer/composer:lts /usr/bin/composer /usr/bin/composer

# Install dependencies
RUN apk add --no-cache nginx php81-pecl-apcu \
    && apk add --update --no-cache --virtual .build-dependencies $PHPIZE_DEPS linux-headers \
    && docker-php-ext-install pdo pdo_mysql \
    && pecl install apcu xdebug \
    && docker-php-ext-enable apcu xdebug \
    && pecl clear-cache \
    && apk del .build-dependencies

# Copy xdebug configuration
COPY build/app/docker-php-ext-xdebug.ini /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

# Copy timezone configuration
COPY build/app/timezone.ini /usr/local/etc/php/conf.d/timezone.ini

# Copy project files
COPY project ${APPDIR}

# Test nginx configuration
RUN nginx -t

# Start PHP fpm and nginx
EXPOSE 8080
CMD ["sh", "-c", "php-fpm -D && nginx -g 'daemon off;'"]

FROM base AS builder
ENV APP_ENV=prod

# Copy Project
COPY project ${APPDIR}

# Install composer packages
COPY --from=composer/composer:lts /usr/bin/composer /usr/bin/composer
RUN cd /var/www/project \
    && composer install --no-dev --no-scripts --optimize-autoloader

# Warmup cache
RUN rm -rf ${APPDIR}/var \
    && mkdir ${APPDIR}/var \
    && bin/console cache:warmup


FROM base AS runner
# Set environment variables
ENV APP_ENV=prod

# Set short commit hash environment variable
ARG CI_COMMIT_SHORT_SHA
ENV CI_COMMIT_SHORT_SHA=$CI_COMMIT_SHORT_SHA

# Set non-root user and group
RUN deluser --remove-home www-data \
    && addgroup -g 10001 -S symfony \
    && adduser -u 10001 -S symfony -G symfony

# Install runner dependencies
RUN apk add --no-cache nginx php81-pecl-apcu \
    && apk add --no-cache --update --virtual .build-dependencies $PHPIZE_DEPS \
    && docker-php-ext-install pdo pdo_mysql \
    && pecl install apcu \
    && docker-php-ext-enable apcu \
    && pecl clear-cache \
    && apk del .build-dependencies

# Setup nginx
COPY build/app/default.conf /etc/nginx/http.d/default.conf

RUN sed -i '/user nginx;/d' /etc/nginx/nginx.conf \
    && nginx -t

# Copy App
COPY --from=builder ${APPDIR} ${APPDIR}

# Adjust ownership and permissions for log directory
RUN chown -R symfony:symfony /var/www/project/var/log  \
    && chown -R symfony:symfony /var/lib/nginx/logs/* /run/nginx/* /var/lib/nginx

# Setup crontab
COPY build/app/crontab /etc/crontabs/symfony
RUN chown -R symfony:symfony /etc/crontabs/symfony

# Latest releases available at https://github.com/aptible/supercronic/releases
ENV SUPERCRONIC_URL=https://github.com/aptible/supercronic/releases/download/v0.2.29/supercronic-linux-amd64 \
    SUPERCRONIC=supercronic-linux-amd64 \
    SUPERCRONIC_SHA1SUM=cd48d45c4b10f3f0bfdd3a57d054cd05ac96812b

RUN curl -fsSLO "$SUPERCRONIC_URL" \
    && echo "${SUPERCRONIC_SHA1SUM}  ${SUPERCRONIC}" | sha1sum -c - \
    && chmod +x "$SUPERCRONIC" \
    && mv "$SUPERCRONIC" "/usr/local/bin/${SUPERCRONIC}" \
    && ln -s "/usr/local/bin/${SUPERCRONIC}" /usr/local/bin/supercronic

# Switch to non-root user
USER symfony
RUN touch /run/nginx/nginx.pid

# Start PHP fpm and nginx
EXPOSE 8080

CMD ["sh", "-c", "supercronic /etc/crontabs/symfony && php-fpm -D && nginx -g 'daemon off;'"]
