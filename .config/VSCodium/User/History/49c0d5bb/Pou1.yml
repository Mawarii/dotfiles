#
# Docker compose project used to startup the test environment.
#
# Usage:
#     Start:    docker-compose up -d
#     Shutdown: docker-compose down
#     Logs:     docker-compose logs
#
# Configuration:
#   This file represents the architecture of the Domibus single node setup with MySQL

version: '3.5'
services:
  #
  # Domibus Tomcat MySQL Configuration
  #
  # Optional: can provide your own external database
  mysql:
    platform: linux/amd64
    build:
      dockerfile: ./build/mysql/Dockerfile
    container_name: domibus-mysql
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - NET_RAW
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - shared_db_file_system:/var/lib/mysql
    ports:
      - "13306:3306"

  tomcat:
    platform: linux/amd64
    image: gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/images/regmo/domibus-tomcat:v1.2.4
    # build:
    #   dockerfile: ./build/tomcat/Dockerfile
    container_name: domibus-tomcat
    cap_drop:
      - NET_RAW
    environment:
      - DB_TYPE=${DB_TYPE}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_USER=${MYSQL_USER}
      - DB_PASS=${MYSQL_PASSWORD}
      - LOGGER_LEVEL_ORG_APACHE_CXF=ALL
      - CHECK_DEFAULT_PASSWD=false
    ports:
      - "18080:8080"
    # volumes:
      # - ./domibus:/data/tomcat/conf/domibus
    depends_on:
      - mysql

volumes:
  shared_db_file_system:
