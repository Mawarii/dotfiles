---
- name: Install required packages
  ansible.builtin.apt:
    pkg:
      - vim
      - fail2ban
      - rsyslog
      - kubelet
      - kubeadm
      - kubectl
      - cri-o
    state: present
    update_cache: true

- name: Hold Kubernetes packages
  block:
    - name: Hold kubeadm package
      ansible.builtin.dpkg_selections:
        name: kubeadm
        selection: hold

    - name: Hold kubelet package
      ansible.builtin.dpkg_selections:
        name: kubelet
        selection: hold

    - name: Hold kubectl package
      ansible.builtin.dpkg_selections:
        name: kubectl
        selection: hold

    - name: Hold cri-o package
      ansible.builtin.dpkg_selections:
        name: cri-o
        selection: hold

- name: Update all packages to their latest version
  when: auto_upgrades
  ansible.builtin.apt:
    name: "*"
    state: latest
    only_upgrade: true
    update_cache: true

- name: Remove dependencies that are no longer required
  ansible.builtin.apt:
    autoremove: true

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /run/reboot-required
  register: reboot_required_file
