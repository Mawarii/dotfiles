apiVersion: apps/v1
kind: Deployment
metadata:
  name: govforms2-workflow-core
  labels:
    k8s-env: develop
spec:
  template:
    spec:
      imagePullSecrets:
        - name: gitlab-registry-govforms2-workflow-core
        - name: gitlab-registry-govforms2-kosit-validator
        - name: gitlab-registry-version-sidecar
      initContainers:
        - name: database-migrate
          image: DOCKER_IMAGE_1
          command:
            - "sh"
            - "-c"
            - |
              php bin/console doctrine:database:create -n --if-not-exists -k api --connection antrag
              php bin/console doctrine:database:create -n --if-not-exists -k api --connection user
              php bin/console doctrine:database:create -n --if-not-exists -k api --connection form
              php bin/console doctrine:database:create -n --if-not-exists -k api --connection workflow
              php bin/console doctrine:database:create -n --if-not-exists -k api --connection fitconnect
              php bin/console doctrine:migrations:migrate --all-or-nothing --allow-no-migration -n -q -k api --configuration 'context/api/config/packages/migrations/antrag.yaml'
              php bin/console doctrine:migrations:migrate --all-or-nothing --allow-no-migration -n -q -k api --configuration 'context/api/config/packages/migrations/user.yaml'
              php bin/console doctrine:migrations:migrate --all-or-nothing --allow-no-migration -n -q -k api --configuration 'context/api/config/packages/migrations/form.yaml'
              php bin/console doctrine:migrations:migrate --all-or-nothing --allow-no-migration -n -q -k api --configuration 'context/api/config/packages/migrations/workflow.yaml'
              php bin/console doctrine:migrations:migrate --all-or-nothing --allow-no-migration -n -q -k api --configuration 'context/api/config/packages/migrations/fitconnect.yaml'
      containers:
        - name: application
          env:
            - name: MAILBOX_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: govforms2-workflow-core-secrets
                  key: MAILBOX_PASSWORD
            - name: MAILER_DSN
              value: "smtp://efa%40publicplan.de:$(MAILBOX_PASSWORD)@smtp.office365.com:587?verify_peer=1"
            - name: RABBITMQ_DEFAULT_USER
              value: "govforms2"
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-auth
                  key: rabbitmq-password
            - name: RABBITMQ_URL
              value: "rabbitmq-headless.govforms2-workflow-core.svc:5672"
            - name: RABBITMQ_DSN
              value: "amqp://$(RABBITMQ_DEFAULT_USER):$(RABBITMQ_DEFAULT_PASS)@$(RABBITMQ_URL)"
          envFrom:
            - secretRef:
                name: govforms2-workflow-core-secrets
            - configMapRef:
                name: govforms2-workflow-core-configmap

