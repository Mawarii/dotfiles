version: "3.5"
services:
  app:
    build:
      target: prod
      context: .
      dockerfile: ./build/app/Dockerfile
    container_name: "${PROJECT_NAME}-app"
    working_dir: "/var/www/project"
    env_file:
      - .env
    volumes:
      - "$SYNC_PATH/:/var/www/project:cached"
    extra_hosts:
      - host.docker.internal:host-gateway
    environment:
      SSH_AUTH_SOCK: /ssh-agent
    networks:
      web:
        aliases:
          - "${PROJECT_NAME}.${DOMAIN_SUFFIX}"
    labels:
      - "traefik.backend=${PROJECT_NAME}-app"
      - traefik.enable=true
      - traefik.docker.network=web
      - "traefik.frontend.rule=Host:${PROJECT_NAME}.${DOMAIN_SUFFIX}"
      - traefik.port=8080
      - traefik.protocol=http
#    restart: unless-stopped
#    cap_drop:
#      - NET_RAW
#    security_opt:
#      - no-new-privileges:true
#    read_only: true
#    tmpfs:
#      - /tmp
#      - /var/lib/nginx/logs:uid=10001,gid=10001
#      - /var/log/nginx:uid=10001,gid=10001
#      - /var/run:uid=10001,gid=10001
#      - /var/cache/nginx:uid=10001,gid=10001
#      - /etc/nginx/conf.d:uid=10001,gid=10001
#      - /run/nginx:uid=10001,gid=10001
#      - /var/www/project/var:uid=10001,gid=10001

  db:
    image: mariadb:${DB_VERSION}
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${DB_NAME}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - 33062:3306
    networks:
      web:

volumes:
  db_data:

networks:
  web:
    external: true
