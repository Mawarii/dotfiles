---
- name: Get kubeadm join command
  ansible.builtin.shell: |
    sudo kubeadm token create --print-join-command
  changed_when: false
  register: join_command

- name: Get kubeadm join command
  ansible.builtin.shell: |
    set -o pipefail
    sudo kubeadm init phase upload-certs --upload-certs | tail -n 1
  changed_when: false
  register: kubeadm_cert_key

- name: Set variables for join-cp.yaml template
  ansible.builtin.set_fact:
    local_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(local_ip_address_range) }}"
    kubeadm_join_token: "{{ join_command.stdout.split(' ')[4] }}"
    kubeadm_cert_hash: "{{ join_command.stdout.split(' ')[6] }}"
    kubeadm_cert_key: "{{ kubeadm_cert_key.stdout }}"

- name: Generate join-cp.yaml file
  ansible.builtin.template:
    src: ./templates/join-cp.yaml.j2
    dest: /tmp/join-cp.yaml
    mode: '0700'
