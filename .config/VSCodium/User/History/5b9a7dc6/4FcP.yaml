---
- name: Get kubeadm join token and certificate hash
  ansible.builtin.shell: |
    sudo kubeadm token create --print-join-command --ttl 1h
  changed_when: false
  register: join_command

- name: Get kubeadm certificate key
  ansible.builtin.shell: |
    set -o pipefail
    sudo kubeadm init phase upload-certs --upload-certs | tail -n 1
  args:
    executable: /bin/bash
  changed_when: false
  register: kubeadm_cert_key

- name: Set variables for join template
  ansible.builtin.set_fact:
    kubeadm_join_token: "{{ join_command.stdout.split(' ')[4] }}"
    kubeadm_cert_hash: "{{ join_command.stdout.split(' ')[6] }}"
    kubeadm_cert_key: "{{ kubeadm_cert_key.stdout }}"
