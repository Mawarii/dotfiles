---
- name: Upgrade kubeadm package
  when: auto_upgrades and kube_upgrade_needed
  ansible.builtin.apt:
    pkg:
      - kubeadm={{ kube_version_latest.stdout }}
    state: present
    update_cache: true
    allow_change_held_packages: true

- name: Hold kubeadm package
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: hold

- name: Check kubeadm upgrade
  ansible.builtin.command:
    cmd: kubeadm upgrade plan
  changed_when: false

- name: Apply kubeadm upgrade
  ansible.builtin.command:
    cmd: kubeadm upgrade apply "v{{ kube_version_latest.split('-')[0] }}"
  changed_when: true

- name: Drain node
  ansible.builtin.command: |
    kubectl drain {{ inventory_hostname }} \
      --ignore-daemonsets \
      --delete-emptydir-data \
      --grace-period=120 \
      --timeout=180s \
      --kubeconfig /etc/kubernetes/admin.conf
  changed_when: true
  delegate_to: "{{ groups['control-plane'][0] }}"

- name: Wait for the drain to finish
  ansible.builtin.pause:
    seconds: 210

- name: Upgrade other Kubernetes packages
  when: auto_upgrades and kube_upgrade_needed
  ansible.builtin.apt:
    pkg:
      - kubelet={{ kube_version_latest.stdout }}
      - kubectl={{ kube_version_latest.stdout }}
    state: present
    update_cache: true
    allow_change_held_packages: true

- name: Hold kubeadm package
  ansible.builtin.dpkg_selections:
    name: kubelet
    selection: hold

- name: Hold kubeadm package
  ansible.builtin.dpkg_selections:
    name: kubectl
    selection: hold
