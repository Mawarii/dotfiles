---
- name: Upgrade kubeadm package
  when: auto_upgrades and kube_upgrade_needed
  ansible.builtin.apt:
    pkg:
      - kubeadm={{ kube_version_latest.stdout }}
    state: present
    update_cache: true
    allow_change_held_packages: true

- name: Hold kubeadm package
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: hold

- name: Check kubeadm upgrade
  ansible.builtin.command:
    cmd: kubeadm upgrade plan
  changed_when: false

- name: Apply kubeadm upgrade
  ansible.builtin.command:
    cmd: kubeadm upgrade apply "v{{ kube_version_latest.split('-')[0] }}"
  changed_when: true

- name: Drain node
  ansible.builtin.command: |
    kubectl drain {{ inventory_hostname }} \
      --ignore-daemonsets \
      --delete-emptydir-data \
      --grace-period={{ drainGracePeriod }} \
      --timeout={{ drainTimeOut }} \
      --kubeconfig /etc/kubernetes/admin.conf
  delegate_to: "{{ groups['control-plane'][0] }}"
  changed_when: true
