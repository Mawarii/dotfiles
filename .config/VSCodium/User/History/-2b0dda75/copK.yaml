---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxmox-inventory
spec:
  replicas: 0
  selector:
    matchLabels:
      app: proxmox-inventory
  template:
    metadata:
      labels:
        app: proxmox-inventory
    spec:
      containers:
        - name: proxmox-inventory
          image: harbor.cloudical.net/cci-tools/proxmox-vm-inventory:v1.2.1
          args:
            - "-f"
            - "/conf/config.yaml"
          ports:
            - containerPort: 8081
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            runAsGroup: 10001
            runAsUser: 10001
          resources:
            requests:
              cpu: "0.5"
              memory: "0.5G"
            limits:
              cpu: "2"
              memory: "2G"
          volumeMounts:
            - name: config
              mountPath: /conf
        - name: oauth-proxy
          image: quay.io/oauth2-proxy/oauth2-proxy:v6.1.1
          securityContext:
            allowPrivilegeEscalation: true
            readOnlyRootFilesystem: false
            runAsGroup: 0
            runAsUser: 0
          args:
            - --provider=keycloak
            - --email-domain=*
            - --cookie-domain=proxmox-inventory.cloudical.net
            - --redirect-url=https://proxmox-inventory.cloudical.net/oauth2/callback
            - --upstream=http://127.0.0.1:8080/
            - --http-address=:80
            - --skip-provider-button
            - --login-url=https://keycloak.cloudical.net/auth/realms/Cloudical/protocol/openid-connect/auth
            - --redeem-url=https://keycloak.cloudical.net/auth/realms/Cloudical/protocol/openid-connect/token
            - --validate-url=https://keycloak.cloudical.net/auth/realms/Cloudical/protocol/openid-connect/userinfo
            - --scope=openid profile email
          env:
            - name: OAUTH2_PROXY_CLIENT_ID
              value: "proxmox-inventory.cloudical.net"
            - name: OAUTH2_PROXY_CLIENT_SECRET
              value: "DwIQI9WYKL6L85n5tRexWCYDnrTNCQQD"
            - name: OAUTH2_PROXY_COOKIE_SECRET
              value: "KBRbn3iJl7EbF1cfkdSa0g=="
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          resources:
            requests:
              cpu: "0.5"
              memory: "0.5G"
            limits:
              cpu: "2"
              memory: "2G"
      volumes:
        - name: config
          configMap:
            name: pve-conf
            items:
              - key: yaml
                path: config.yaml
