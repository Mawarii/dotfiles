# Author: Gurumoorthy Mohan
services:
  forms-flow-forms-db:
    container_name: forms-flow-forms-db
    image: {{ formio_database_image }}
    restart: always
    hostname: forms-flow-forms-db
    ports:
      - '27018:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: {{ formio.database.username }}
      MONGO_INITDB_ROOT_PASSWORD: {{ formio_database_password }}
      MONGO_INITDB_DATABASE: {{ formio.database.database }}
    volumes:
      - ./001_custom_user.js:/docker-entrypoint-initdb.d/001_user.js:ro
      - forms-flow-forms-mongodb-data:/data/db/
      - forms-flow-forms-mongodb-logs:/var/log/mongodb/
      - forms-flow-forms-mongodb-conf:/etc/mongod.conf
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-forms:
    container_name: forms-flow-forms
    image: {{ formio_image }}
    restart: always
    depends_on:
      - forms-flow-forms-db
    ports:
      - '3001:3001'
    environment:
      DEBUG: formio:*
      NODE_CONFIG: "{\"mongo\":\"mongodb://{{ formio.database.username }}:{{ formio_database_password }}@forms-flow-forms-db:27017/${{ formio.database.database }}?authMechanism=SCRAM-SHA-1&authSource=admin\"}"
      ROOT_EMAIL: {{ formio.root_email }}
      ROOT_PASSWORD: {{ formio_root_password }}
      FORMIO_DOMAIN: {{ formio_url }}
      FORMIO_JWT_SECRET: {{ formio_jwt_secret }}
      NO_INSTALL: ${NO_INSTALL:-0}
      MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
    stdin_open: true
    tty: true
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-bpm-db:
    image: {{ bpm_database_image }}
    container_name: forms-flow-bpm-db
    environment:
      POSTGRES_USER: {{ bpm.database.username }}
      POSTGRES_PASSWORD: {{ bpm_database_password }}
      POSTGRES_DB: {{ bpm.database.database }}
    volumes:
      - forms-flow-bpm-postgresql-data:/bitnami/postgresql
    ports:
      - '5432:5432'
    restart: always
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-bpm:
    container_name: forms-flow-bpm
    image: {{ bpm_image }}
    restart: always
    depends_on:
      - forms-flow-bpm-db
    ports:
      - '8000:8080'
    environment:
      KEYCLOAK_URL: {{ keycloak_url }}
      KEYCLOAK_URL_REALM: ${KEYCLOAK_URL_REALM:-forms-flow-ai}
      KEYCLOAK_CLIENTID: ${KEYCLOAK_BPM_CLIENT_ID:-forms-flow-bpm}
      KEYCLOAK_CLIENTSECRET: {{ bpm_keycloak_clientsecret }}
      CAMUNDA_JDBC_URL: ${CAMUNDA_JDBC_URL:-jdbc:postgresql://forms-flow-bpm-db:5432/formsflow-bpm}
      CAMUNDA_JDBC_USER: {{ bpm.database.username }}
      CAMUNDA_JDBC_PASSWORD: {{ bpm_database_password }}
      CAMUNDA_JDBC_DRIVER: ${CAMUNDA_JDBC_DRIVER:-org.postgresql.Driver}
#      CAMUNDA_HIKARI_CONN_TIMEOUT: ${CAMUNDA_HIKARI_CONN_TIMEOUT}
#      CAMUNDA_HIKARI_IDLE_TIMEOUT: ${CAMUNDA_HIKARI_IDLE_TIMEOUT}
#      CAMUNDA_HIKARI_MAX_POOLSIZE: ${CAMUNDA_HIKARI_MAX_POOLSIZE}
#      CAMUNDA_HIKARI_VALID_TIMEOUT: ${CAMUNDA_HIKARI_VALID_TIMEOUT}
#      CAMUNDA_BPM_HISTORY_LEVEL: ${CAMUNDA_BPM_HISTORY_LEVEL}
#      CAMUNDA_AUTHORIZATION_FLAG: ${CAMUNDA_AUTHORIZATION_FLAG}
#      CAMUNDA_AUTHORIZATION_REVOKE_CHECK_FLAG: ${CAMUNDA_AUTHORIZATION_REVOKE_CHECK_FLAG}
#      CAMUNDA_JOB_CORE_POOL_SIZE: ${CAMUNDA_JOB_CORE_POOL_SIZE}
#      CAMUNDA_JOB_LOCK_TIME_MILLIS: ${CAMUNDA_JOB_LOCK_TIME_MILLIS}
#      CAMUNDA_JOB_MAXJOBS_PER_ACQUISITION: ${CAMUNDA_JOB_MAXJOBS_PER_ACQUISITION}
#      CAMUNDA_JOB_MAX_POOL_SIZE: ${CAMUNDA_JOB_MAX_POOL_SIZE}
#      CAMUNDA_JOB_QUEUE_SIZE: ${CAMUNDA_JOB_QUEUE_SIZE}
#      CAMUNDA_JOB_WAIT_TIME_MILLIS: ${CAMUNDA_JOB_WAIT_TIME_MILLIS}
#      CAMUNDA_JOB_MAX_WAIT: ${CAMUNDA_JOB_MAX_WAIT}
#      CAMUNDA_METRICS_FLAG: ${CAMUNDA_METRICS_FLAG}
      CAMUNDA_APP_ROOT_LOG_FLAG: ${CAMUNDA_APP_ROOT_LOG_FLAG:-error}
      FORMSFLOW_API_URL: ${FORMSFLOW_API_URL}
      FORMIO_URL: {{ formio_url }}
      FORMIO_ROOT_EMAIL: {{ formio.root_email }}
      FORMIO_ROOT_PASSWORD: {{ formio_root_password }}
      APP_SECURITY_ORIGIN: ${APP_SECURITY_ORIGIN:-*}
      WEBSOCKET_SECURITY_ORIGIN: ${WEBSOCKET_SECURITY_ORIGIN}
      WEBSOCKET_MESSAGE_TYPE: ${WEBSOCKET_MESSAGE_TYPE:-TASK_EVENT}
      WEBSOCKET_ENCRYPT_KEY: {{ bpm_websocket_encryption_key }}
      DATA_BUFFER_SIZE: ${DATA_BUFFER_SIZE:-2}
      IDENTITY_PROVIDER_MAX_RESULT_SIZE: ${IDENTITY_PROVIDER_MAX_RESULT_SIZE:-250}
      DATA_ANALYSIS_URL: ${DATA_ANALYSIS_URL}
      CUSTOM_SUBMISSION_URL: ${CUSTOM_SUBMISSION_URL}
      CUSTOM_SUBMISSION_ENABLED: ${CUSTOM_SUBMISSION_ENABLED:-false}
      MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
      KEYCLOAK_ENABLE_CLIENT_AUTH: ${KEYCLOAK_ENABLE_CLIENT_AUTH:-false}
      KEYCLOAK_WEB_CLIENTID: ${KEYCLOAK_WEB_CLIENTID:-forms-flow-web}
      FORMSFLOW_ADMIN_URL: ${FORMSFLOW_ADMIN_URL:-}
      REDIS_ENABLED: ${REDIS_ENABLED:-false}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSCODE: ${REDIS_PASSCODE:-changeme}
      SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-false}
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-web-root-config:
    container_name: forms-flow-web-root-config
    image: {{ web_image }}
    restart: always
    depends_on:
      - forms-flow-webapi
    entrypoint: /bin/sh -c "/usr/share/nginx/html/config/env.sh && nginx -g 'daemon off;'"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      REACT_APP_API_SERVER_URL: {{ formio_url }}
      REACT_APP_API_PROJECT_URL: {{ formio_url }}
      REACT_APP_KEYCLOAK_CLIENT: ${KEYCLOAK_WEB_CLIENT_ID:-forms-flow-web}
      REACT_APP_WEB_BASE_URL: ${FORMSFLOW_API_URL}
      REACT_APP_BPM_URL: ${BPM_API_URL}
      REACT_APP_WEBSOCKET_ENCRYPT_KEY: {{ bpm_websocket_encryption_key }}
      REACT_APP_KEYCLOAK_URL_REALM: ${KEYCLOAK_URL_REALM:-forms-flow-ai}
      REACT_APP_KEYCLOAK_URL: {{ keycloak_url }}
      REACT_APP_APPLICATION_NAME: ${APPLICATION_NAME:-formsflow.ai}
      REACT_APP_ENABLE_APPLICATION_ACCESS_PERMISSION_CHECK: ${ENABLE_APPLICATION_ACCESS_PERMISSION_CHECK:-false}
      REACT_APP_WEB_BASE_CUSTOM_URL: ${WEB_BASE_CUSTOM_URL}
      REACT_APP_MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
      REACT_APP_MT_ADMIN_BASE_URL: ${MT_ADMIN_BASE_URL}
      REACT_APP_MT_ADMIN_BASE_URL_VERSION: ${MT_ADMIN_BASE_URL_VERSION}
      REACT_APP_CUSTOM_SUBMISSION_URL: ${CUSTOM_SUBMISSION_URL}
      REACT_APP_CUSTOM_SUBMISSION_ENABLED: ${CUSTOM_SUBMISSION_ENABLED:-false}
      REACT_APP_DRAFT_ENABLED: ${DRAFT_ENABLED:-false}
      REACT_APP_DRAFT_POLLING_RATE: ${DRAFT_POLLING_RATE:-15000}
      REACT_APP_EXPORT_PDF_ENABLED: ${EXPORT_PDF_ENABLED:-false}
      REACT_APP_PUBLIC_WORKFLOW_ENABLED: ${PUBLIC_WORKFLOW_ENABLED:-false}
      REACT_APP_DOCUMENT_SERVICE_URL: ${DOCUMENT_SERVICE_URL}
      REACT_APP_CUSTOM_THEME_URL: ${CUSTOM_THEME_URL}
      REACT_APP_CUSTOM_RESOURCE_BUNDLE_URL: ${CUSTOM_RESOURCE_BUNDLE_URL}
      REACT_APP_KEYCLOAK_ENABLE_CLIENT_AUTH: ${KEYCLOAK_ENABLE_CLIENT_AUTH:-false}
      REACT_APP_ENABLE_FORMS_MODULE: ${ENABLE_FORMS_MODULE:-true}
      REACT_APP_ENABLE_TASKS_MODULE: ${ENABLE_TASKS_MODULE:-true}
      REACT_APP_ENABLE_DASHBOARDS_MODULE: ${ENABLE_DASHBOARDS_MODULE:-true}
      REACT_APP_ENABLE_PROCESSES_MODULE: ${ENABLE_PROCESSES_MODULE:-true}
      REACT_APP_ENABLE_APPLICATIONS_MODULE: ${ENABLE_APPLICATIONS_MODULE:-true}
      REACT_APP_DATE_FORMAT: ${DATE_FORMAT:-DD-MM-YY}
      REACT_APP_TIME_FORMAT: ${TIME_FORMAT:-hh:mm:ss A}
      # REACT_APP_KEYCLOAK_URL: https://forms-flow-idm-keycloak.formsflow.publicplan.cloud
      # KEYCLOAK_URL: https://forms-flow-idm-keycloak.formsflow.publicplan.cloud
      # MF_FORMSFLOW_THEME_URL: https://forms-flow-micro-frontend.hzd.formsflow.publicplan.cloud
      # MF_FORMSFLOW_NAV_URL: https://forms-flow-micro-frontend.formsflow.publicplan.cloud/nav/forms-flow-nav.js
      # MF_FORMSFLOW_SERVICE_URL: https://forms-flow-micro-frontend.formsflow.publicplan.cloud/service/forms-flow-service.js
      # MF_FORMSFLOW_ADMIN_URL: https://forms-flow-micro-frontend.formsflow.publicplan.cloud/admin/forms-flow-admin.js
      # MF_FORMSFLOW_WEB_URL: https://forms-flow-micro-frontend.formsflow.publicplan.cloud/web/forms-flow-web.js
    ports:
      - '3000:8080'
    tty: true
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-webapi-db:
    container_name: forms-flow-webapi-db
    image: {{ webapi_database_image }}
    environment:
      POSTGRES_USER: {{ webapi.database.username }}
      POSTGRES_PASSWORD: {{ webapi_database_password }}
      POSTGRES_DB: {{ webapi.database.database }}
    ports:
      - '6432:5432'
    restart: always
    volumes:
      - forms-flow-webapi-postgresql-data:/bitnami/postgresql
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-webapi:
    container_name: forms-flow-webapi
    image: {{ webapi_image }}
    restart: always
    depends_on:
      - forms-flow-webapi-db
      - forms-flow-forms
    entrypoint: "/wait-for-service.sh forms-flow-webapi-db:5432 -s -- ./entrypoint.sh"
    ports:
      - '5000:5000'
    volumes:
      - forms-flow-webapi-data:/app:rw
    environment:
      INSIGHT_API_KEY: ${INSIGHT_API_KEY}
      INSIGHT_API_URL: {{ webapi_url }}
      DATABASE_URL: postgresql://{{ webapi.database.username }}:{{ webapi_database_password }}@forms-flow-webapi-db:5432/{{ webapi.database.database }}
      BPM_TOKEN_API: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}/protocol/openid-connect/token
      BPM_CLIENT_ID: ${KEYCLOAK_BPM_CLIENT_ID:-forms-flow-bpm}
      BPM_CLIENT_SECRET: {{ bpm_keycloak_clientsecret }}
      BPM_API_URL: ${BPM_API_URL}
      FORMSFLOW_API_CORS_ORIGINS: ${FORMSFLOW_API_CORS_ORIGINS:-*}
      JWT_OIDC_WELL_KNOWN_CONFIG: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}/.well-known/openid-configuration
      JWT_OIDC_ALGORITHMS: 'RS256'
      JWT_OIDC_JWKS_URI: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}/protocol/openid-connect/certs
      JWT_OIDC_ISSUER: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}
      JWT_OIDC_AUDIENCE: ${KEYCLOAK_WEB_CLIENT_ID:-forms-flow-web}
      JWT_OIDC_CACHING_ENABLED: 'True'
      JWT_OIDC_JWKS_CACHE_TIMEOUT: 300
      KEYCLOAK_URL: {{ keycloak_url }}
      KEYCLOAK_URL_REALM: ${KEYCLOAK_URL_REALM:-forms-flow-ai}
      WEB_API_BASE_URL: ${FORMSFLOW_API_URL}
      FORMIO_URL: {{ formio_url }}
      FORMIO_ROOT_EMAIL: {{ formio.root_email }}
      FORMIO_ROOT_PASSWORD: {{ formio_root_password }}
      FORMIO_JWT_SECRET: {{ formio_jwt_secret }}
      KEYCLOAK_ENABLE_CLIENT_AUTH: ${KEYCLOAK_ENABLE_CLIENT_AUTH:-false}
      MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
      FORM_EMBED_JWT_SECRET: ${FORM_EMBED_JWT_SECRET:-f6a69a42-7f8a-11ed-a1eb-0242ac120002}
      API_LOG_ROTATION_WHEN: ${API_LOG_ROTATION_WHEN:-d}
      API_LOG_ROTATION_INTERVAL: ${API_LOG_ROTATION_INTERVAL:-1}
      API_LOG_BACKUP_COUNT: ${API_LOG_BACKUP_COUNT:-7}
    stdin_open: true
    tty: true
    networks:
      - forms-flow-network
      - caddy-net

  forms-flow-documents-api:
    container_name: forms-flow-documents-api
    image: harbor.dev.publicplan.cloud/docker_proxy/formsflow/forms-flow-documents-api:v5.3.1
    ports:
      - '5006:5006'
    volumes:
      - forms-flow-documents-api-data:/app:rw
    environment:
      DATABASE_URL: ${FORMSFLOW_API_DB_URL:-postgresql://postgres:changeme@forms-flow-webapi-db:5432/webapi}
      FORMSFLOW_API_CORS_ORIGINS: ${FORMSFLOW_API_CORS_ORIGINS:-*}
      JWT_OIDC_WELL_KNOWN_CONFIG: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}/.well-known/openid-configuration
      JWT_OIDC_JWKS_URI: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}/protocol/openid-connect/certs
      JWT_OIDC_ISSUER: {{ keycloak_url }}/auth/realms/${KEYCLOAK_URL_REALM:-forms-flow-ai}
      JWT_OIDC_AUDIENCE: ${KEYCLOAK_WEB_CLIENT_ID:-forms-flow-web}
      JWT_OIDC_CACHING_ENABLED: 'True'
      KEYCLOAK_URL: {{ keycloak_url }}
      KEYCLOAK_URL_REALM: ${KEYCLOAK_URL_REALM:-forms-flow-ai}
      FORMSFLOW_API_URL: ${FORMSFLOW_API_URL}
      FORMSFLOW_DOC_API_URL: ${DOCUMENT_SERVICE_URL}
      FORMIO_URL: {{ formio_url }}
      FORMIO_ROOT_EMAIL: {{ formio.root_email }}
      FORMIO_ROOT_PASSWORD: {{ formio_root_password }}
      CHROME_DRIVER_PATH: ${CHROME_DRIVER_PATH}
      CUSTOM_SUBMISSION_URL: ${CUSTOM_SUBMISSION_URL}
      CUSTOM_SUBMISSION_ENABLED: ${CUSTOM_SUBMISSION_ENABLED}
      FORMIO_JWT_SECRET: {{ formio_jwt_secret }}
      MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
      KEYCLOAK_ENABLE_CLIENT_AUTH: ${KEYCLOAK_ENABLE_CLIENT_AUTH:-false}
      API_LOG_ROTATION_WHEN: ${API_LOG_ROTATION_WHEN:-d}
      API_LOG_ROTATION_INTERVAL: ${API_LOG_ROTATION_INTERVAL:-1}
      API_LOG_BACKUP_COUNT: ${API_LOG_BACKUP_COUNT:-7}
    stdin_open: true
    tty: true
    networks:
      - forms-flow-network
      - caddy-net

networks:
  forms-flow-network:
    driver: 'bridge'
  caddy-net:
    name: caddy_proxy
    external: true

volumes:
  forms-flow-bpm-postgresql-data:
  forms-flow-forms-mongodb-data:
  forms-flow-forms-mongodb-logs:
  forms-flow-forms-mongodb-conf:
  forms-flow-webapi-postgresql-data:
  forms-flow-webapi-data:
  forms-flow-documents-api-data:
