kind: Service
apiVersion: v1
metadata:
  name: domibus
  labels:
    app: domibus
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
    app: domibus
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: domibus
  labels:
    app: domibus
spec:
  revisionHistoryLimit: 1
  replicas: 1
  selector:
    matchLabels:
      app: domibus
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: domibus
    spec:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      initContainers:
        - command: ["sh", "-c", "cp -r /data/* /copydata"]
          image: DOMIBUS_TOMCAT_IMAGE
          imagePullPolicy: IfNotPresent
          name: datacopy
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            seccompProfile:
              type: RuntimeDefault
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - mountPath: /copydata
              name: data
      containers:
      - name: domibus
        image: DOMIBUS_TOMCAT_IMAGE
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          seccompProfile:
            type: RuntimeDefault
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 2Gi
        env:
          - name: LOGGER_LEVEL_ORG_APACHE_CXF
            value: DEBUG
          - name: DB_TYPE
            value: MySQL
          - name: DB_HOST
            value: "domibus-mysql"
          - name: DB_PORT
            value: "3306"
          - name: DB_NAME
            valueFrom:
              secretKeyRef:
                name: domibus-mysql
                key: MYSQL_DATABASE
          - name: DB_USER
            valueFrom:
              secretKeyRef:
                name: domibus-mysql
                key: MYSQL_USER
          - name: DB_PASS
            valueFrom:
              secretKeyRef:
                name: domibus-mysql
                key: mysql-password
        volumeMounts:
          # - name: domibus
          #   mountPath: /data/tomcat/conf/domibus
          - name: passwd
            mountPath: /etc/squid
          - name: data
            mountPath: /data
          - name: home
            mountPath: /home/edelivery
          - name: tmp
            mountPath: /tmp
          - name: log
            mountPath: /data/tomcat/logs
          - name: domibus-logback
            mountPath: '/data/tomcat/conf/domibus/logback.xml'
            subPath: 'logback.xml'
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 600
          timeoutSeconds: 5
          periodSeconds: 10
      volumes:
      - name: domibus
        persistentVolumeClaim:
          claimName: domibusvol
      - name: log #tomcat logs
        persistentVolumeClaim:
          claimName: log-pvc
      - name: passwd
        emptyDir: {}
      - name: data
        emptyDir: {}
      - name: home
        emptyDir: {}
      - name: tmp
        emptyDir: {}
      - name: domibus-logback
        configMap:
          name: domibus-logback
      imagePullSecrets:
        - name: gitlab-registry
