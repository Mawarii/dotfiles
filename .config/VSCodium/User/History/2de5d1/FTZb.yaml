apiVersion: batch/v1
kind: CronJob
metadata:
  name: drupal-rebuild-cronjob
spec:
  suspend: true
  schedule: "30 0 * * *" # every day at 00:30
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  timeZone: Europe/Berlin
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          restartPolicy: OnFailure
          imagePullSecrets:
            - name: pullsecret-drupal

          containers:
            - name: drupal-rebuild-cronjob
              image: gitlab.publicplan.cloud:5050/themenwelt-portale/recht.nrw
              command:
                - /bin/bash
                - -c
                - |
                  export drush=vendor/drush/drush/drush && \
                  echo "Clearing cache" && \
                  $drush cr -v && \
                  echo "Executing index rebuild" && \
                  $drush rnrw_search_api:rebuild-index \
                    --batch-size=25 \
                    --loop-limit=1000 \
                    --indexes=opensearch_lvn,opensearch_internet
              imagePullPolicy: IfNotPresent
              resources:
                requests:
                  cpu: 500m
                  memory: 512Mi
                limits:
                  cpu: 1500m
                  memory: 2Gi
              securityContext:
                runAsUser: 33
                runAsGroup: 33
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                capabilities:
                  drop: ["ALL"]
                seccompProfile:
                  type: RuntimeDefault
              volumeMounts:
                - mountPath: /var/www/html/web/sites/default/settings.cluster.php
                  name: settings
                  subPath: settings.cluster.php
                - mountPath: /var/run
                  name: varrun
                - mountPath: /tmp
                  name: tmp
                - mountPath: /var/www/html/web/sites/default/files
                  name: files

              env:
                - name: MYSQL_USER
                  value: rechtnrw
                - name: MYSQL_DATABASE
                  value: rechtnrw
                - name: MYSQL_HOST
                  value: hsi-intranet-mariadb
                - name: MYSQL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: mariadb-password
                      name: hsi-intranet-mariadb
                - name: HTTP_BASIC_USER
                  value: stage
                - name: HTTP_BASIC_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: PASSWORD
                      name: http-basic
                - name: OPENSEARCH_URL
                  value: https://opensearch.rnrw.stage.publicplan.cloud:443
                - name: STATIC_SITE_BASE_URL
                  value: https://static.public.rnrw.stage.publicplan.cloud
                - name: OPENSEARCH_MIDDLEWARE_URL
                  value: https://drupal.hsi-intranet.rnrw.stage.publicplan.cloud/search-middleware
                - name: SEARCH_MIDDLEWARE_TRUSTED_ORIGINS
                  value: https://drupal.hsi-intranet.rnrw.stage.publicplan.cloud, https://static.public.rnrw.stage.publicplan.cloud
                - name: SEARCH_MIDDLEWARE_TOKEN
                  valueFrom:
                    secretKeyRef:
                      key: TOKEN
                      name: search-middleware-token
                - name: STATIC_SITE_BASE_URL_INTRANET
                  value: https://drupal.hsi-intranet.rnrw.stage.publicplan.cloud
                - name: DRUPAL_TRUSTED_HOSTS
                  value: drupal.hsi-intranet.rnrw.stage.publicplan.cloud

          volumes:
            - name: varrun
              emptyDir: {}
            - name: tmp
              emptyDir: {}
            - name: config
              configMap:
                name: configuration-files
            - name: settings
              configMap:
                name: settings
            - name: files
              emptyDir: {}
