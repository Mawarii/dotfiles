---
- name: Check which SSH port is available
  ansible.builtin.wait_for:
    port: "{{ ssh_port }}"
    host: "{{ ansible_host }}"
    timeout: 3
  register: new_ssh_port
  ignore_errors: true
  delegate_to: localhost
  become: false

- name: "Set SSH port and user to the detected values"
  ansible.builtin.set_fact:
    ansible_port: "{{ ssh_port if new_ssh_port.failed == false else default_ssh_port }}"
    ansible_user: "{{ ssh_user if new_ssh_port.failed == false else default_ssh_user }}"
