apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob-postgresql-backup
spec:
  schedule: "0 */3 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          name: postgresql-backup-job
        spec:
          securityContext:
            fsGroup: 10001
            runAsGroup: 10001
            runAsNonRoot: true
            runAsUser: 10001
          imagePullSecrets:
            - name: gitlab-registry
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: "gitlab.publicplan.cloud:5050/themenwelt-wirtschaft/infrastruktur/tools/backup-jobs:v1.3.0"
              securityContext:
                runAsGroup: 10001
                runAsNonRoot: true
                runAsUser: 10001
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - "ALL"
                seccompProfile:
                  type: RuntimeDefault
                readOnlyRootFilesystem: true
                privileged: false
              envFrom:
                - secretRef:
                    name: cluster-stage-vars
              env:
                #? possible values postgres / mariadb / mysql / mongodb / pvc
                - name: DB_TYPE
                  value: postgres
                - name: DB_USER
                  value: postgres
                - name: DB_HOST
                  value: postgres-wsp-postgresql
                #! You must set the port
                #! on non Postgres DB's
                - name: DB_PORT
                  value: "5432"
                - name: DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      key: postgres-password
                      name: postgres-wsp-postgresql
                - name: BUCKET_SUBDIR
                  valueFrom:
                    fieldRef:
                      fieldPath: "metadata.namespace"
              volumeMounts:
                - mountPath: "/tmp"
                  name: tmp
                - mountPath: "/home/tools"
                  name: home
          volumes:
            - name: tmp
              emptyDir: {}
            - name: home
              emptyDir: {}
