---
- name: Configure firewall
  hosts: localhost
  become: false
  gather_facts: false
  roles:
    - role: configure-firewall
      custom_action: open-default-ssh-port
    - role: configure-firewall
      custom_action: configure-hetzner-firewall
      when: hcloud_token != ""

- name: Machine hardening and preparation
  hosts: all
  become: true
  gather_facts: true
  roles:
    - role: prepare-machines

- name: Close default SSH port
  hosts: localhost
  become: false
  gather_facts: false
  roles:
    - role: configure-firewall
      custom_action: close-default-ssh-port

- name: Add Kubernetes apt packages
  hosts: all
  become: true
  gather_facts: true
  roles:
    - role: install-packages
    - role: reboot-machine

- name: Bootstrap first controlplane
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-cluster
      custom_action: first-controlplane
    - role: bootstrap-cluster
      custom_action: generate-join-variables

- name: Join new controlplane
  hosts: controlplanes[1:]
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-cluster
      custom_action: join-node

- name: Join new worker
  hosts: worker
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-cluster
      custom_action: join-node

- name: Cleanup sensitive data after bootstrap
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-cluster
      custom_action: delete-join-token

- name: Install base Kubernetes applications
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: install-cni
    - role: install-storage
    - role: install-argocd
