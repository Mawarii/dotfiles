---
- name: Configure firewall
  hosts: localhost
  become: false
  gather_facts: false
  roles:
    - role: configure-firewall

- name: Machine preparation and hardening
  hosts: all
  become: true
  gather_facts: false
  roles:
    - role: prepare-machine

- name: Delete default SSH firewall
  hosts: localhost
  become: false
  gather_facts: false
  roles:
    - role: delete-default-ssh-firewall

- name: Bootstrap first controlplane
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-first-controlplane

- name: Configure other controlplanes
  hosts: controlplanes[1:]
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-additional-node

- name: Configure worker
  hosts: worker
  become: true
  gather_facts: true
  roles:
    - role: bootstrap-additional-node

- name: Upgrade Kubernetes
  hosts: all
  become: true
  gather_facts: true
  serial: 1
  roles:
    - role: upgrade-kubernetes
      when: auto_upgrades and kube_upgrade_needed

- name: Cleanup sensitive data
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: cleanup-sensitive-data

- name: Install base Kubernetes applications
  hosts: controlplanes[0]
  become: true
  gather_facts: true
  roles:
    - role: install-cni
    - role: install-storage
    - role: install-argocd
