---
- name: Get local IP address
  ansible.builtin.set_fact:
    local_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(local_node_network) }}"

- name: Check if node is already initialized
  block:
    - name: Verify the existence of the kubelet config file
      ansible.builtin.stat:
        path: /var/lib/kubelet/config.yaml
      register: kubelet_config

    - name: Verify if local IP is part of `kubectl get nodes`
      ansible.builtin.command:
        cmd: kubectl get nodes --no-headers -o custom-columns=":.status.addresses[?(@.type=='InternalIP')].address"
      changed_when: false
      register: node_ips

- name: Generate init.yaml file
  when: not local_ip_address[0] in node_ips.stdout and not kubelet_config.stat.exists
  ansible.builtin.template:
    src: "{{ role_path }}/templates/init.yaml.j2"
    dest: /tmp/init.yaml
    mode: '0700'

- name: Run init command
  when: not local_ip_address[0] in node_ips.stdout and not kubelet_config.stat.exists
  ansible.builtin.command:
    cmd: sudo kubeadm init --config /tmp/init.yaml --upload-certs
  changed_when: false
