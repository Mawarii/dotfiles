---
- name: Get local IP address
  ansible.builtin.set_fact:
    local_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(local_ip_address_range) }}"

- name: Generate init.yaml file
  ansible.builtin.template:
    src: "{{ role_path }}/templates/init.yaml.j2"
    dest: /tmp/init.yaml
    mode: '0700'

- name: Check if node is already initialized
  ansible.builtin.command:
    cmd: sudo kubeadm init phase preflight --config /tmp/init.yaml
  failed_when: false
  changed_when: false
  register: preflight_check

- name: Run init command
  ansible.builtin.shell: |
    sudo kubeadm init --config /tmp/init.yaml --upload-certs
  changed_when: false
  when: preflight_check.rc == 0
